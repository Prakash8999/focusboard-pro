name: Node.js CI/CD Pipeline

on:
  push:
    branches: [ "main" ]

jobs:
  # JOB 1: THE FACTORY (CI)
  build:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [20.x]

    steps:
    - uses: actions/checkout@v4          # 1. Get the code
    
    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4        # 2. Install Node.js
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        
    - run: npm ci                        # 3. Clean Install dependencies
    
    # - run: npm run test                  # 4. Run Tests (Fail Fast!)
    
    - run: npm run build --if-present    # 5. Build the app (creates 'dist' folder)

    - name: Upload Build Artifact        # 6. Save 'dist' to the Locker
      uses: actions/upload-artifact@v4
      with:
        name: my-build-files
        path: dist
    # JOB 2: THE DELIVERY TRUCK (CD)
  deploy:
    needs: build
    runs-on: ubuntu-latest
    
    steps:
    - name: Download the artifact
      uses: actions/download-artifact@v4
      with:
        name: my-build-files
        path: dist  # Unpack the zip into a local 'dist' folder

    # STEP A: COPY FILES TO EC2 ðŸšš
    - name: Copy files via SSH
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        source: "dist/*"            # Take everything inside the local 'dist' folder...
        target: "/home/ubuntu/project/focusboard-pro" # ...and put it into this folder on EC2. UPDATE THIS PATH!

    # STEP B: RESTART PM2 ðŸ”„
    - name: Restart PM2
      uses: appleboy/ssh-action@v0.1.10
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          pm2 reload all    # Or use the specific app name: pm2 reload my-app
          echo "Deployment successful!"
  
